{{define "title"}}Admin: Projects - {{appName}}{{end}}

{{define "content"}}
<div class="admin-page">
    <h1>Manage Projects</h1>

    {{if .IsAdmin}}
    <div class="admin-nav">
        <a href="{{url "/admin/projects"}}" class="admin-nav-link active">Projects</a>
        <a href="{{url "/admin/users"}}" class="admin-nav-link">Users</a>
        <a href="{{url "/admin/robots"}}" class="admin-nav-link">Robot Users</a>
        <a href="{{url "/admin/groups"}}" class="admin-nav-link">Group Mappings</a>
        <a href="{{url "/admin/global-access"}}" class="admin-nav-link">Global Access</a>
    </div>
    {{end}}

    <div class="admin-create-form">
        <h2>Create Project</h2>
        <form method="POST" action="{{url "/admin/projects"}}" id="create-project-form">
            <div class="form-row">
                <div class="form-group" style="flex:1;min-width:180px;">
                    <label for="name">Name</label>
                    <input type="text" id="name" name="name" required placeholder="My Project">
                </div>
                <div class="form-group" id="slug-group" style="flex:1;min-width:180px;">
                    <label for="slug">Slug</label>
                    <input type="text" id="slug" name="slug" required pattern="[a-z0-9-]+" placeholder="my-project">
                </div>
                <div class="form-group" style="align-self:end;">
                    <label style="display:inline;font-weight:400;cursor:pointer;">
                        <input type="checkbox" id="auto-slug" checked> Auto slug
                    </label>
                </div>
            </div>
            <div class="form-group">
                <label for="description">Description</label>
                <textarea id="description" name="description" rows="4" placeholder="Optional description (Markdown supported)" style="resize:vertical;"></textarea>
            </div>
            <div class="form-row" style="align-items:center;">
                <div class="form-group" style="margin-bottom:0;">
                    <select id="visibility" name="visibility">
                        <option value="public">Public</option>
                        <option value="private">Private</option>
                        <option value="custom" selected>Custom</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-primary">Create</button>
            </div>
        </form>
    </div>

    <script>
    (function() {
        var nameInput = document.getElementById("name");
        var slugInput = document.getElementById("slug");
        var slugGroup = document.getElementById("slug-group");
        var autoSlug = document.getElementById("auto-slug");

        function deriveSlug(name) {
            return name.toLowerCase().trim()
                .replace(/[^a-z0-9\s-]/g, "")
                .replace(/[\s]+/g, "-")
                .replace(/-+/g, "-")
                .replace(/^-|-$/g, "");
        }

        function updateSlugVisibility() {
            if (autoSlug.checked) {
                slugGroup.style.display = "none";
                slugInput.removeAttribute("required");
                slugInput.value = deriveSlug(nameInput.value);
            } else {
                slugGroup.style.display = "";
                slugInput.setAttribute("required", "");
                if (!slugInput.value) slugInput.value = deriveSlug(nameInput.value);
            }
        }

        autoSlug.addEventListener("change", updateSlugVisibility);
        nameInput.addEventListener("input", function() {
            if (autoSlug.checked) slugInput.value = deriveSlug(nameInput.value);
        });

        updateSlugVisibility();
    })();
    </script>

    {{if .IsAdmin}}
    <div style="margin-bottom: 1.5rem; display: flex; align-items: center; gap: 1rem; flex-wrap: wrap;">
        <form method="POST" action="{{url "/admin/reindex"}}" class="inline-form"
            onsubmit="return confirm('Rebuild the full-text search index? This runs in the background.')">
            <button type="submit" class="btn btn-secondary" {{if .ReindexRunning}}disabled{{end}}>
                {{if .ReindexRunning}}Reindexing...{{else}}Rebuild Search Index{{end}}
            </button>
        </form>
        <form method="POST" action="{{url "/admin/deploy-docs"}}" class="inline-form"
            onsubmit="return confirm('Deploy built-in documentation as asiakirjat-docs project?')">
            <button type="submit" class="btn btn-secondary">Deploy Built-in Docs</button>
        </form>
        {{if .ReindexRunning}}
        <span style="color: var(--color-text-muted); font-size: 0.875rem;">
            Progress: {{.ReindexProgress}}
        </span>
        {{end}}
    </div>
    {{end}}

    <input type="text" class="admin-filter" id="project-filter" placeholder="Filter projects..." autocomplete="off">

    <table class="admin-table" id="project-table">
        <thead>
            <tr>
                <th>Slug</th>
                <th>Name</th>
                <th>Visibility</th>
                <th>Created</th>
                {{if .IsAdmin}}<th>Actions</th>{{end}}
            </tr>
        </thead>
        <tbody>
            {{range .Projects}}
            <tr>
                <td><a href="{{url "/project/"}}{{.Slug}}">{{.Slug}}</a></td>
                <td>{{.Name}}</td>
                <td>{{.Visibility}}</td>
                <td>{{.CreatedAt.Format "2006-01-02"}}</td>
                {{if $.IsAdmin}}
                <td>
                    <a href="{{url "/admin/projects/"}}{{.Slug}}/edit" class="btn btn-small btn-secondary">Edit</a>
                    <form method="POST" action="{{url "/admin/projects/"}}{{.Slug}}/delete" class="inline-form"
                        onsubmit="return confirm('Delete project {{.Name}}?')">
                        <button type="submit" class="btn btn-small btn-danger">Delete</button>
                    </form>
                </td>
                {{end}}
            </tr>
            {{else}}
            <tr><td colspan="5">No projects yet.</td></tr>
            {{end}}
        </tbody>
    </table>

    <script>
    (function() {
        var input = document.getElementById("project-filter");
        var tbody = document.querySelector("#project-table tbody");
        var rows = tbody.querySelectorAll("tr");
        var noMatch = document.createElement("tr");
        noMatch.className = "filter-hidden";
        noMatch.innerHTML = '<td colspan="{{if .IsAdmin}}5{{else}}4{{end}}" style="color:var(--color-text-muted);text-align:center;">No matching projects.</td>';
        tbody.appendChild(noMatch);

        input.addEventListener("input", function() {
            var q = input.value.toLowerCase().trim();
            var visible = 0;
            rows.forEach(function(row) {
                var cells = row.querySelectorAll("td");
                if (cells.length < 3) return;
                var text = cells[0].textContent.toLowerCase() + " " + cells[1].textContent.toLowerCase() + " " + cells[2].textContent.toLowerCase();
                if (!q || text.indexOf(q) !== -1) {
                    row.classList.remove("filter-hidden");
                    visible++;
                } else {
                    row.classList.add("filter-hidden");
                }
            });
            noMatch.className = visible === 0 && q ? "" : "filter-hidden";
        });
    })();
    </script>
</div>
{{end}}
