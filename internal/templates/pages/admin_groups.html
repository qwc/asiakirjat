{{define "title"}}Admin: Group Mappings - {{appName}}{{end}}

{{define "content"}}
<div class="admin-page">
    <h1>Authentication Group Mappings</h1>

    <div class="admin-nav">
        <a href="{{url "/admin/projects"}}" class="admin-nav-link">Projects</a>
        <a href="{{url "/admin/users"}}" class="admin-nav-link">Users</a>
        <a href="{{url "/admin/robots"}}" class="admin-nav-link">Robot Users</a>
        <a href="{{url "/admin/groups"}}" class="admin-nav-link active">Group Mappings</a>
    </div>

    <div class="admin-info">
        <p>Map authentication groups (LDAP/OAuth2) to project access. When users log in, they automatically receive access to projects based on their group membership.</p>
        <p><strong>Note:</strong> Mappings marked as "Config" were loaded from the config file and cannot be modified through this UI.</p>
    </div>

    {{if .Flash}}
    <div class="flash flash-{{.Flash.Type}}">{{.Flash.Message}}</div>
    {{end}}

    <div class="admin-create-form">
        <h2>Create Mapping</h2>
        <form method="POST" action="{{url "/admin/groups"}}" id="mapping-form">
            <div class="form-row-vertical">
                <div class="form-row">
                    <div class="form-group">
                        <label for="auth_source">Auth Source</label>
                        <select id="auth_source" name="auth_source" required>
                            <option value="ldap">LDAP</option>
                            <option value="oauth2">OAuth2</option>
                        </select>
                    </div>
                    <div class="form-group form-group-wide">
                        <label for="group_identifier">Group Identifier</label>
                        <input type="text" id="group_identifier" name="group_identifier" required
                            placeholder="e.g., cn=editors,ou=groups,dc=example,dc=com">
                    </div>
                    <div class="form-group">
                        <label for="role">Role</label>
                        <select id="role" name="role" required>
                            <option value="viewer">Viewer</option>
                            <option value="editor">Editor</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label for="project_search">Projects</label>
                    <div class="project-selector">
                        <div class="project-search-wrapper">
                            <input type="text" id="project_search" placeholder="Search projects..." autocomplete="off">
                            <div class="project-dropdown" id="project_dropdown"></div>
                        </div>
                        <div class="selected-projects" id="selected_projects">
                            <span class="placeholder">No projects selected</span>
                        </div>
                    </div>
                </div>
                <button type="submit" class="btn btn-primary">Add Mapping</button>
            </div>
        </form>
    </div>

    {{if .Mappings}}
    <table class="admin-table">
        <thead>
            <tr>
                <th>Auth Source</th>
                <th>Group Identifier</th>
                <th>Role</th>
                <th>Projects</th>
            </tr>
        </thead>
        <tbody>
            {{range .Mappings}}
            <tr>
                <td><span class="badge badge-{{.AuthSource}}">{{.AuthSource}}</span></td>
                <td class="group-id">{{.GroupIdentifier}}</td>
                <td>{{.Role}}</td>
                <td class="projects-cell">
                    {{range .Projects}}
                    <div class="project-tag">
                        <span class="project-name">{{.ProjectName}}</span>
                        {{if .FromConfig}}
                        <span class="badge badge-config badge-small">Config</span>
                        {{else}}
                        <form method="POST" action="{{url "/admin/groups/"}}{{.MappingID}}/delete" class="inline-form"
                            onsubmit="return confirm('Remove access to {{.ProjectName}}?')">
                            <button type="submit" class="btn-remove" title="Remove project">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/>
                                </svg>
                            </button>
                        </form>
                        {{end}}
                    </div>
                    {{end}}
                </td>
            </tr>
            {{end}}
        </tbody>
    </table>
    {{else}}
    <p class="empty-message">No group mappings configured. Create one above or add mappings to your config file.</p>
    {{end}}
</div>

<script>
(function() {
    var projects = [
        {{range .Projects}}
        {id: {{.ID}}, name: "{{.Name}}", slug: "{{.Slug}}"},
        {{end}}
    ];

    var selectedProjects = new Map();
    var searchInput = document.getElementById('project_search');
    var dropdown = document.getElementById('project_dropdown');
    var selectedContainer = document.getElementById('selected_projects');
    var form = document.getElementById('mapping-form');

    function renderDropdown(filter) {
        var filtered = projects.filter(function(p) {
            if (selectedProjects.has(p.id)) return false;
            if (!filter) return true;
            var q = filter.toLowerCase();
            return p.name.toLowerCase().indexOf(q) !== -1 ||
                   p.slug.toLowerCase().indexOf(q) !== -1;
        });

        if (filtered.length === 0 || !filter) {
            dropdown.style.display = 'none';
            return;
        }

        dropdown.innerHTML = filtered.slice(0, 10).map(function(p) {
            return '<div class="dropdown-item" data-id="' + p.id + '" data-name="' + p.name + '">' +
                   '<span class="item-name">' + p.name + '</span>' +
                   '<span class="item-slug">' + p.slug + '</span>' +
                   '</div>';
        }).join('');
        dropdown.style.display = 'block';
    }

    function renderSelected() {
        if (selectedProjects.size === 0) {
            selectedContainer.innerHTML = '<span class="placeholder">No projects selected</span>';
            return;
        }

        var html = '';
        selectedProjects.forEach(function(name, id) {
            html += '<div class="selected-project" data-id="' + id + '">' +
                    '<span>' + name + '</span>' +
                    '<input type="hidden" name="project_ids[]" value="' + id + '">' +
                    '<button type="button" class="btn-remove-selected" title="Remove">&times;</button>' +
                    '</div>';
        });
        selectedContainer.innerHTML = html;
    }

    function addProject(id, name) {
        selectedProjects.set(id, name);
        renderSelected();
        searchInput.value = '';
        dropdown.style.display = 'none';
    }

    function removeProject(id) {
        selectedProjects.delete(id);
        renderSelected();
    }

    searchInput.addEventListener('input', function() {
        renderDropdown(this.value);
    });

    searchInput.addEventListener('focus', function() {
        if (this.value) renderDropdown(this.value);
    });

    dropdown.addEventListener('click', function(e) {
        var item = e.target.closest('.dropdown-item');
        if (item) {
            addProject(parseInt(item.dataset.id), item.dataset.name);
        }
    });

    selectedContainer.addEventListener('click', function(e) {
        if (e.target.classList.contains('btn-remove-selected')) {
            var parent = e.target.closest('.selected-project');
            if (parent) {
                removeProject(parseInt(parent.dataset.id));
            }
        }
    });

    document.addEventListener('click', function(e) {
        if (!e.target.closest('.project-selector')) {
            dropdown.style.display = 'none';
        }
    });

    form.addEventListener('submit', function(e) {
        if (selectedProjects.size === 0) {
            e.preventDefault();
            alert('Please select at least one project');
        }
    });
})();
</script>

<style>
.admin-info {
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    border-radius: 4px;
    padding: 1rem;
    margin-bottom: 1.5rem;
}
.admin-info p {
    margin: 0 0 0.5rem 0;
}
.admin-info p:last-child {
    margin-bottom: 0;
}
.form-row-vertical {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}
.form-group-wide {
    flex: 2;
}
.badge {
    display: inline-block;
    padding: 0.25rem 0.5rem;
    border-radius: 3px;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
}
.badge-small {
    padding: 0.125rem 0.375rem;
    font-size: 0.625rem;
}
.badge-ldap {
    background: #e3f2fd;
    color: #1565c0;
}
.badge-oauth2 {
    background: #f3e5f5;
    color: #7b1fa2;
}
.badge-config {
    background: #fff3e0;
    color: #e65100;
}
.group-id {
    font-family: monospace;
    font-size: 0.875rem;
    word-break: break-all;
    max-width: 400px;
}
.empty-message {
    color: var(--color-text-muted);
    text-align: center;
    padding: 2rem;
}
.flash {
    padding: 1rem;
    border-radius: 4px;
    margin-bottom: 1rem;
}
.flash-success {
    background: #e8f5e9;
    color: #2e7d32;
    border: 1px solid #a5d6a7;
}
.flash-error {
    background: #ffebee;
    color: #c62828;
    border: 1px solid #ef9a9a;
}

/* Project selector */
.project-selector {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}
.project-search-wrapper {
    position: relative;
}
.project-search-wrapper input {
    width: 100%;
}
.project-dropdown {
    display: none;
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    border-radius: 4px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    z-index: 100;
    max-height: 200px;
    overflow-y: auto;
}
.dropdown-item {
    padding: 0.5rem 0.75rem;
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.dropdown-item:hover {
    background: var(--color-hover);
}
.item-name {
    font-weight: 500;
}
.item-slug {
    font-size: 0.75rem;
    color: var(--color-text-muted);
    font-family: monospace;
}
.selected-projects {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    min-height: 2rem;
    padding: 0.5rem;
    border: 1px solid var(--color-border);
    border-radius: 4px;
    background: var(--color-surface);
}
.selected-projects .placeholder {
    color: var(--color-text-muted);
    font-size: 0.875rem;
}
.selected-project {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    background: var(--color-primary);
    color: white;
    padding: 0.25rem 0.5rem;
    border-radius: 3px;
    font-size: 0.875rem;
}
.btn-remove-selected {
    background: none;
    border: none;
    color: white;
    cursor: pointer;
    font-size: 1rem;
    line-height: 1;
    padding: 0 0.125rem;
    opacity: 0.8;
}
.btn-remove-selected:hover {
    opacity: 1;
}

/* Projects cell in table */
.projects-cell {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
}
.project-tag {
    display: inline-flex;
    align-items: center;
    gap: 0.375rem;
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    padding: 0.25rem 0.5rem;
    border-radius: 3px;
    font-size: 0.875rem;
}
.project-name {
    font-weight: 500;
}
.btn-remove {
    background: none;
    border: none;
    color: var(--color-danger);
    cursor: pointer;
    padding: 0.125rem;
    display: flex;
    align-items: center;
    opacity: 0.7;
}
.btn-remove:hover {
    opacity: 1;
}
.inline-form {
    display: inline;
}
</style>
{{end}}
