{{define "title"}}Admin: Users - {{appName}}{{end}}

{{define "content"}}
<div class="admin-page">
    <h1>Manage Users</h1>

    <div class="admin-nav">
        <a href="{{url "/admin/projects"}}" class="admin-nav-link">Projects</a>
        <a href="{{url "/admin/users"}}" class="admin-nav-link active">Users</a>
        <a href="{{url "/admin/robots"}}" class="admin-nav-link">Robot Users</a>
        <a href="{{url "/admin/groups"}}" class="admin-nav-link">Group Mappings</a>
        <a href="{{url "/admin/global-access"}}" class="admin-nav-link">Global Access</a>
    </div>

    <div class="admin-create-form">
        <h2>Create User</h2>
        <form method="POST" action="{{url "/admin/users"}}">
            <div class="form-row">
                <div class="form-group">
                    <label for="username">Username</label>
                    <input type="text" id="username" name="username" required>
                </div>
                <div class="form-group">
                    <label for="password">Password</label>
                    <input type="password" id="password" name="password" required>
                </div>
                <div class="form-group">
                    <label for="email">Email</label>
                    <input type="email" id="email" name="email">
                </div>
                <div class="form-group">
                    <label for="role">Role</label>
                    <select id="role" name="role">
                        <option value="viewer">Viewer</option>
                        <option value="editor">Editor</option>
                        <option value="admin">Admin</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-primary">Create</button>
            </div>
        </form>
    </div>

    <input type="text" class="admin-filter" id="user-filter" placeholder="Filter users..." autocomplete="off">

    <table class="admin-table" id="user-table">
        <thead>
            <tr>
                <th>Username</th>
                <th>Email</th>
                <th>Role</th>
                <th>Auth Source</th>
                <th>Created</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {{range .Users}}
            <tr>
                <td>{{.Username}}</td>
                <td>{{.Email}}</td>
                <td>
                    <form method="POST" action="{{url "/admin/users/"}}{{.ID}}/role" class="inline-form">
                        <select name="role" onchange="this.form.submit()">
                            <option value="viewer" {{if eq .Role "viewer"}}selected{{end}}>viewer</option>
                            <option value="editor" {{if eq .Role "editor"}}selected{{end}}>editor</option>
                            <option value="admin" {{if eq .Role "admin"}}selected{{end}}>admin</option>
                        </select>
                    </form>
                </td>
                <td>{{.AuthSource}}</td>
                <td>{{.CreatedAt.Format "2006-01-02"}}</td>
                <td>
                    {{if eq .AuthSource "builtin"}}
                    <form method="POST" action="{{url "/admin/users/"}}{{.ID}}/password" class="inline-form">
                        <input type="password" name="password" placeholder="New password" required>
                        <button type="submit" class="btn btn-small">Reset</button>
                    </form>
                    {{end}}
                    <form method="POST" action="{{url "/admin/users/"}}{{.ID}}/delete" class="inline-form"
                        onsubmit="return confirm('Delete user {{.Username}}?')">
                        <button type="submit" class="btn btn-small btn-danger">Delete</button>
                    </form>
                </td>
            </tr>
            {{else}}
            <tr><td colspan="6">No users.</td></tr>
            {{end}}
        </tbody>
    </table>

    <script>
    (function() {
        var input = document.getElementById("user-filter");
        var tbody = document.querySelector("#user-table tbody");
        var rows = tbody.querySelectorAll("tr");
        var noMatch = document.createElement("tr");
        noMatch.className = "filter-hidden";
        noMatch.innerHTML = '<td colspan="6" style="color:var(--color-text-muted);text-align:center;">No matching users.</td>';
        tbody.appendChild(noMatch);

        input.addEventListener("input", function() {
            var q = input.value.toLowerCase().trim();
            var visible = 0;
            rows.forEach(function(row) {
                var cells = row.querySelectorAll("td");
                if (cells.length < 4) return;
                var text = cells[0].textContent.toLowerCase() + " " + cells[1].textContent.toLowerCase() + " " + cells[2].textContent.toLowerCase() + " " + cells[3].textContent.toLowerCase();
                if (!q || text.indexOf(q) !== -1) {
                    row.classList.remove("filter-hidden");
                    visible++;
                } else {
                    row.classList.add("filter-hidden");
                }
            });
            noMatch.className = visible === 0 && q ? "" : "filter-hidden";
        });
    })();
    </script>
</div>
{{end}}
