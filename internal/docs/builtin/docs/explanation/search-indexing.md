# Search Indexing

How full-text search works in Asiakirjat.

## Overview

Asiakirjat uses [Bleve](https://blevesearch.com/) for full-text search. Bleve is an embedded search library written in Go that provides features similar to Elasticsearch but without external dependencies.

## Index Location

The search index is stored at:

```
{storage.base_path}/.search-index/
```

For example: `data/docs/.search-index/`

## What Gets Indexed

When documentation is uploaded:

1. Archive is extracted
2. HTML files (`.html`, `.htm`) are scanned
3. Text content is extracted (excluding scripts, styles, navigation)
4. Page title is extracted from `<title>` tag
5. Content is indexed with metadata

### Indexed Fields

| Field | Type | Description |
|-------|------|-------------|
| `project_slug` | Keyword | Project identifier |
| `project_name` | Text | Project display name |
| `version_tag` | Keyword | Version string |
| `file_path` | Keyword | Relative path in archive |
| `page_title` | Text | HTML title (boosted in search) |
| `text_content` | Text | Page body text |

## Text Extraction

HTML is parsed and text is extracted:

```html
<html>
<head><title>API Reference</title></head>
<body>
  <nav>Navigation links...</nav>         <!-- Skipped -->
  <script>console.log('hi')</script>     <!-- Skipped -->
  <style>.class { color: red }</style>   <!-- Skipped -->
  <main>
    <h1>Authentication</h1>              <!-- Indexed -->
    <p>Configure authentication...</p>   <!-- Indexed -->
  </main>
</body>
</html>
```

Skipped elements:
- `<script>` (JavaScript)
- `<style>` (CSS)
- `<nav>` (Navigation)

## Search Query Processing

When a user searches:

1. Query is parsed
2. Multiple query types are combined:
   - **Match query**: Standard term matching
   - **Phrase query**: Exact phrase matching (boosted)
   - **Fuzzy query**: Typo tolerance (lower boost)
3. Results are filtered by access permissions
4. Top results with snippets are returned

### Query Types and Boosting

```
Query: "configure authentication"

├── Match query (text_content) - boost: 1.0
├── Phrase query (text_content) - boost: 2.0  (exact phrase)
├── Phrase query (page_title) - boost: 5.0    (title match)
├── Fuzzy query (text_content) - boost: 0.5   (typo tolerance)
└── Fuzzy query (page_title) - boost: 0.8
```

## Version Filtering

By default, search only returns results from the **latest version** of each project. This prevents outdated documentation from cluttering results.

The "latest" version is determined by semantic version sorting.

Options:
- **Default**: Search latest versions only
- **All versions**: Search all versions (`all_versions=true`)
- **Specific version**: Filter by version tag

## Indexing Operations

### On Upload

When documentation is uploaded:

```
1. If version exists: delete old index entries
2. Extract archive
3. Walk HTML files
4. Extract text from each file
5. Batch index documents
```

### On Version Delete

```
1. Query all documents with project_id/version_id prefix
2. Batch delete matching documents
```

### Full Reindex

Admins can rebuild the entire index:

```
1. Delete all existing documents
2. For each project:
   3. For each version:
      4. Re-extract and index all HTML files
```

This is useful after:
- Index corruption
- Schema changes
- Bulk imports

## Search Results

Results include:

```json
{
  "project_slug": "api-docs",
  "project_name": "API Documentation",
  "version_tag": "v2.0.0",
  "file_path": "auth/configure.html",
  "page_title": "Configure Authentication",
  "snippet": "...set up <mark>authentication</mark> for your API...",
  "url": "/project/api-docs/v2.0.0/auth/configure.html"
}
```

### Snippets

Snippets are generated by Bleve's highlighter:
- Extract text around matching terms
- Wrap matches in `<mark>` tags
- Truncate to reasonable length

## Performance Considerations

### Index Size

The index size depends on:
- Number of HTML files
- Amount of text content
- Number of versions

Typical ratio: Index is ~10-30% of total HTML text size.

### Search Speed

Bleve provides sub-second search for typical documentation sets. For very large indexes (100k+ documents), consider:
- Limiting results per query
- Using more specific queries
- Filtering by project/version

### Indexing Speed

Indexing runs asynchronously after upload. Typical speeds:
- ~100-500 files/second
- Depends on file size and content complexity

## Troubleshooting

### Search Not Finding Content

- Check content is in HTML files (not JS/CSS)
- Verify files have `.html` or `.htm` extension
- Ensure content isn't in skipped tags (script, style, nav)

### Outdated Results

- Search defaults to latest versions
- Try "all versions" search
- May need to wait for index update after upload

### Index Corruption

If search behaves unexpectedly:

1. Go to Admin > Projects
2. Click "Rebuild Search Index"
3. Wait for reindexing to complete

### Empty Index

If no results appear:
- Check documentation has been uploaded
- Verify HTML files exist in storage
- Check logs for indexing errors
